<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>ðŸ’¬ Chat â€” {{ nickname|e }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- data-uri SVG favicon (no file needed) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%232a2e37'/%3E%3Ctext x='50' y='60' font-size='50' text-anchor='middle' fill='%23fff'%3EðŸ’¬%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="left">
      <h1>ðŸ’¬ Chat Universel</h1>
    </div>
    <div class="right">
      <span class="user">ConnectÃ© : <strong>{{ nickname|e }}</strong></span>
      <button id="dark-toggle" title="Basculer thÃ¨me">ðŸŒ™</button>
      <a href="{{ url_for('logout') }}"><button class="logout">DÃ©connexion</button></a>
    </div>
  </header>

  <main id="chat-area">
    <ul id="messages">
      {% for item in history or [] %}
        {% if item is mapping %}
          {% set nick = item.get('nickname', '') %}
          {% set msg = item.get('message', '') %}
          {% set color = item.get('color', '#cccccc') %}
          <li class="{{ 'system' if not nick else '' }}">
            {% if nick %}
              <strong class="nickname" data-color="{{ color|e }}">{{ nick|e }}:</strong>
              {{ msg|e }}
            {% else %}
              <em>{{ msg|e }}</em>
            {% endif %}
          </li>
        {% else %}
          <li><em>{{ item|e }}</em></li>
        {% endif %}
      {% endfor %}
    </ul>
  </main>

  <form id="form" autocomplete="off">
    <input id="input" placeholder="Ã‰cris ton message..." required />
    <button type="submit">Envoyer</button>
  </form>

<script>
  (function(){
    const socket = io();
    const nickname = "{{ nickname|e }}";
    const messages = document.getElementById('messages');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const darkToggle = document.getElementById('dark-toggle');

    // join after connect
    socket.on('connect', () => socket.emit('join', { nickname }));

    function addMessage(data){
      if(!data) return;
      const li = document.createElement('li');
      if(data.nickname){
        const strong = document.createElement('strong');
        strong.textContent = `${data.nickname}:`;
        strong.className = 'nickname';
        strong.style.color = data.color || '#cccccc';
        li.appendChild(strong);
        li.appendChild(document.createTextNode(' ' + data.message));
      } else {
        li.className = 'system';
        li.textContent = data.message;
      }
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('message', addMessage);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      socket.emit('message', { nickname, message: text });
      input.value = '';
    });

    // dark mode
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('dark', document.body.classList.contains('dark') ? '1' : '0');
    });
    if (localStorage.getItem('dark') === '1') document.body.classList.add('dark');

    // ensure nickname colors for any pre-rendered messages
    document.querySelectorAll('.nickname').forEach(el=>{
      const c = el.getAttribute('data-color');
      if(c) el.style.color = c;
    });

  })();
</script>
</body>
</html>
